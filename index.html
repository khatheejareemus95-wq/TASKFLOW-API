<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    h1 { text-align: center; }
    form { margin-bottom: 20px; }
    input, select { padding: 6px; margin-right: 10px; }
    button { padding: 6px 12px; }
    .task { border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; }
    .meta { font-size: 0.85em; color: #555; }
    #form-error { color: red; margin-top: 5px; }
  </style>
</head>
<body>

  <h1>Task Dashboard</h1>

  <form id="task-form">
    <input id="title" placeholder="Task Title" required />
    <select id="priority" required>
      <option value="">Select Priority</option>
      <option value="low">low</option>
      <option value="medium">medium</option>
      <option value="high">high</option>
      <option value="urgent">urgent</option>
    </select>
    <button type="submit">Add Task</button>
    <div id="form-error"></div>
  </form>

  <div id="tasks-container">Loading tasks…</div>

  <script>
    const API_BASE = '/api/tasks'; // works with the same server

    // Load tasks on page load
    async function fetchTasks() {
      const container = document.getElementById('tasks-container');
      try {
        const res = await fetch(API_BASE);
        const tasks = await res.json();
        renderTasks(tasks);
      } catch (err) {
        console.error(err);
        container.innerText = 'Unable to load tasks.';
      }
    }

    function renderTasks(tasks) {
      const container = document.getElementById('tasks-container');
      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<i>No tasks yet</i>';
        return;
      }
      container.innerHTML = '';
      tasks.slice().reverse().forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `
          <strong>${escapeHtml(task.title)}</strong>
          <div class="meta">ID: ${task.taskId} • ${new Date(task.createdAt).toLocaleString()} • priority: ${task.priority} • status: ${task.status}</div>
          <p>${escapeHtml(task.description)}</p>
        `;
        container.appendChild(div);
      });
    }

    // Add task to UI immediately after POST
    function addTaskToUI(task) {
      const container = document.getElementById('tasks-container');
      const div = document.createElement('div');
      div.className = 'task';
      div.innerHTML = `
        <strong>${escapeHtml(task.title)}</strong>
        <div class="meta">ID: ${task.taskId} • ${new Date(task.createdAt).toLocaleString()} • priority: ${task.priority} • status: ${task.status}</div>
        <p>${escapeHtml(task.description)}</p>
      `;
      container.insertBefore(div, container.firstChild);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      return String(text).replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    // Handle form submit
    document.getElementById('task-form').addEventListener('submit', async e => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const priority = document.getElementById('priority').value;
      const errorDiv = document.getElementById('form-error');
      errorDiv.innerText = '';

      if (!title) return errorDiv.innerText = 'Title is required';
      if (!['low','medium','high','urgent'].includes(priority)) return errorDiv.innerText = 'Select a valid priority';

      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description: '', priority })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({ error: res.statusText }));
          throw new Error(err.error || 'Server error');
        }
        const task = await res.json();
        addTaskToUI(task);
        e.target.reset();
      } catch (err) {
        console.error(err);
        errorDiv.innerText = 'Failed to create task.';
      }
    });

    document.addEventListener('DOMContentLoaded', fetchTasks);
  </script>

</body>
</html>